{ # this ensures the entire script is downloaded #

# ###################################################################
# ###################################################################
# MAIN
# ###################################################################
# ###################################################################
tools="curl build-essential git bc dtrx ncdu htop trash-cli" 
# silversearcher-ag
mactools="curl build-essential git bc dtrx ncdu htop trash-cli the_silver_searcher"
# Add mutt for email

function main() {
	clear
  define_colors
  banner

  ech "\nSetting Up..." 2
  ech "----------------------------------------------------------------------------" 2
  install_setup

	ech "\nInstalling bash..." 2
  ech "----------------------------------------------------------------------------" 2
	install_bash

  ech "\nExecuting bash..." 2
	. ~/.bashrc

	ech "\nInstall completed.\n\n" 2
}

# FUNCTION TO INSTALL TOOLS
# ###################################################################
function install_tools() {
  clear
  define_colors
  banner

  ech "\nSetting Up..." 2
  ech "----------------------------------------------------------------------------" 2
  install_setup

	ech "\nInstalling Node..." 2
  ech "----------------------------------------------------------------------------" 2
	install_node

	ech "\nInstalling CLI..." 2
  ech "----------------------------------------------------------------------------" 2
	install_cli

	ech "\nInstalling vim..." 2
  ech "----------------------------------------------------------------------------" 2
	install_vim

	ech "\nInstall completed.\n\n" 2
}

# DEFINE BANNER
# ###################################################################
function banner() {
  echo -e "${DARKGRAY}"
  echo -e ".8888b                            dP                dP             dP       "
  echo -e "88   '                            88                88             88       "
  echo -e "88aaa  88d888b. .d8888b. 88d888b. 88  .dP  .d8888b. 88    .d8888b. 88d888b. "
  echo -e "88     88'  '88 88'  '88 88'  '88 88888'   88ooood8 88    Y8ooooo. 88'  '88 "
  echo -e "88     88       88.  .88 88    88 88  '8b. 88.  ... 88          88 88    88 "
  echo -e "dP     dP       '88888P8 dP    dP dP   'YP '88888P' dP 88 '88888P' dP    dP "
  echo -e "----------------------------------------------------------------------------"
  echo -e "${CURSOR}"
}

# DEFINE COLORS
# ###################################################################
function define_colors {
  GREEN="\033[38;05;70m"
  PURPLE="\033[38;05;93m"
  LIGHTPURPLE="\033[38;05;105m"
  LIGHTGRAY="\033[38;05;248m"
  DARKGRAY="\033[38;05;236m"
  CURSOR="\033[00m";
  CURSOR="${LIGHTGRAY}"
}

# SETUP, GIT, ADD THE REPO
# ###################################################################
function install_setup() {
  define_colors

  if isosx; then
    which -s brew
    if [[ $? != 0 ]]; then
      ech "- Installing Homebrew..."
      /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    fi

    ech "- Install Tools..."
    brew install --quieter $mactools &> /dev/null
  fi

  # LINUX BASICS
  # #############################################################
  if islinux; then
    ech "- APT update..."
    sudo apt-get update

    ech "- Install Tools.."
    sudo apt-get install $tools -y
  fi

  # GET REPO
  # #############################################################
	if [ ! -d ~/dotfiles ]; then
		ech "- Cloning dotfiles..."
		git clone --quiet https://github.com/ryan-frankel/dotfiles ~/dotfiles
		cd ~/dotfiles
	else
		ech "- Pulling dotfiles..."
		cd ~/dotfiles
		git pull --quiet origin master 
	fi
}

# FUNCTION FOR INSTALLING NODE + RELATED
# ###################################################################
install_node() {
	ech "- NVM..."
  if [ ! -d "$NVM_DIR" ]; then
    curl --silent -o- https://raw.githubusercontent.com/creationix/nvm/v0.32.0/install.sh | bash &> /dev/null;
    export NVM_DIR="/home/rfrankel/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm
    nvm install node &> /dev/null 
    nvm use node &> /dev/null
    nvm alias default node &> /dev/null
    npm install -g --silent node-gyp &> /dev/null
  fi

}

# FUNCTION FOR COMMAND LINE 
# ###################################################################
install_cli() {
	ech "- Cloning z..."
  if [ ! -d ~/code/z ]; then
    git clone --quiet https://github.com/rupa/z.git ~/code/z &> /dev/null
  fi

  # INSTALL GIT LFS
  #ech "- Git LFS..."
  #if islinux; then
    #hash git-lfs >/dev/null 2>&1 || {
      #curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash &> /dev/null
      #sudo apt-get install git-lfs -y &>/dev/null 
    #}
  #fi

  # GITCONFIG SYMLINK
  rm -rf ~/.gitconfig
  ln -s ~/dotfiles/git/gitconfig ~/.gitconfig

  # INSTALL MUTT
	mkdir -p ~/.mutt
  rm -rf ~/.mutt/muttrc
  ln -s ~/dotfiles/mutt/muttrc ~/.mutt/muttrc
}

# FUNCTION FOR INSTALLING BASH
# ###################################################################
function install_bash() {
	#DELETE EXISTING .bashrc IF THERE IS ONE
	ech "- Delete existing..."
	rm -rf ~/.bashrc &> /dev/null
	rm -rf ~/.bash_profile &> /dev/null

	#SYM LINK NEW .bashrc FILE
	ech "- Create new symlinks..."
	ln -s ~/dotfiles/bashrc/bashrc.sh ~/.bashrc
	ln -s ~/dotfiles/bashrc/bashrc.sh ~/.bash_profile

	#RELOAD .bashrc
  ech "- Reload bashrc..."
  source ~/.bashrc
}

# FUNCTION FOR INSTALLING VIM
# ###################################################################
install_vim() {
	# Delete Existing
	ech "- Delete existing..."
	rm -rf ~/.vimrc
	rm -rf ~/.vim/snippets

	# Symlink New
	ech "- New symlinks..."
	ln -s ~/dotfiles/vimrc/vimrc ~/.vimrc
  if [ -d ~/dotfiles/vimrc/snippets ]; then
  	ln -s ~/dotfiles/vimrc/snippets ~/.vim/snippets 
  fi

	# Install Vundle if Needed
	ech "- Install curl, vim, and vundle..."
  #if islinux; then
    #sudo apt-get -qq install vim -y &> /dev/null
  #fi
  if isosx; then
    brew reinstall --quieter vim
  fi
	if [ ! -d ~/.vim/bundle/vundle/ ]; then
	 git clone --quiet https://github.com/gmarik/vundle.git ~/.vim/bundle/vundle &> /dev/null
	fi

	# Create colors directory
	ech "- Create colors directory..."
	if [ ! -d ~/.vim/colors ]; then
	 mkdir ~/.vim/colors
	fi

	# Download VIM theme
	ech "- Downloading theme..."
	if [ ! -f ~/.vim/colors/wombat256mod.vim ]; then
	 curl --silent -L http://www.vim.org/scripts/download_script.php?src_id=13400 > ~/.vim/colors/wombat256mod.vim
	fi

	# Install bundles
	ech "- Install bundles..."
  vim +PluginInstall +qall
} #install_vim()

# FUNCTION FOR ECHO WITH COLOR OPTION
# ###################################################################
function ech() {
	if [ -z "$2" ]; then
		echo -e " ${GREEN}$1${CURSOR}";
	else
		echo -e "${CURSOR}$1${CURSOR}";
	fi
}

# FUNCTION TO TEST FOR OSX/LINUX/ETC
# ###################################################################
function isosx() {
  if [[ $OSTYPE == *"darwin"* ]]; then
    return 0; # true
  else
    return 1; # false
  fi
}

function islinux() {
  if [[ $OSTYPE == *"linux"* ]]; then
    return 0; # true
  else
    return 1; # false
  fi
}

# FUNCTION FOR COMPILING VIM FROM SOURCE
# ###################################################################
function compile_vim() {
	# Get cmake version

	vim_version=$(vim --version | egrep -o "([0-9]{1,}\.)+[0-9]{1,}" | head -n1)
	hash vim >/dev/null 2>&1 || { vim_version="0"; }

	if should_upgrade $vim_version "8.0"; then 
	
		# Install prereqs
		sudo apt-get install libncurses5-dev libgnome2-dev libgnomeui-dev \
				libgtk2.0-dev libatk1.0-dev libbonoboui2-dev \
				libcairo2-dev libx11-dev libxpm-dev libxt-dev python-dev \
				python3-dev ruby-dev lua5.1 lua5.1-dev libperl-dev git

		# Remove vim
		sudo apt-get remove vim vim-runtime gvim vim-tiny vim-common vim-gui-common vim-nox
		sudo dpkg -r vim

		  # Get vim source
			cd ~
			sudo rm -rf ~/vim
			git clone https://github.com/vim/vim.git ./vim
		  cd vim
		  
		  # Configure installation
		  ./configure --with-features=huge \
			    --enable-multibyte \
			    --enable-rubyinterp=yes \
			    --enable-pythoninterp=yes \
			    --enable-python3interp=yes \
			    --with-python3-config-dir=/usr/lib/python3.5/config-3.5m-x86_64-linux-gnu \
			    --enable-perlinterp=yes \
			    --enable-luainterp=yes \
			    --enable-gui=gtk2 --enable-cscope --prefix=/usr
		  make VIMRUNTIMEDIR=/usr/share/vim/vim80

		  # Get checkinstall
		  sudo apt-get install checkinstall

		  # Install vim
		  cd ~/vim
		  sudo checkinstall

		  # Set Vim as default editor
		  sudo update-alternatives --install /usr/bin/editor editor /usr/bin/vim 1
		  sudo update-alternatives --set editor /usr/bin/vim
		  sudo update-alternatives --install /usr/bin/vi vi /usr/bin/vim 1
		  sudo update-alternatives --set vi /usr/bin/dbus-update-activation-environment
	fi
}

# FUNCTION FOR COMPILING CMAKE
# ###################################################################
function compile_cmake() {
  cd ~
  sudo apt-get install cmake

  # Get cmake version
  cmake_version=$(cmake --version | egrep -o "([0-9]{1,}\.)+[0-9]{1,}")

  if should_upgrade $cmake_version "2.8.11"; then
    # Upgrade cmake if necessary
    cd ~
    rm -rf cmake-2.8.12*
    wget -cL --no-check-certificate https://cmake.org/files/v2.8/cmake-2.8.12.tar.gz \
    && dtrx cmake-2.8.12.tar.gz \
    && cd cmake-2.8.12 \
    && mkdir _build \
    && cd _build \
    && cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr \
    && make \
    && sudo make install \
    && sudo ldconfig
  fi
}


# FUNCTION FOR COMPILING YOUCOMPLETEME
# ###################################################################
function compile_ycm() {
  cd ~

  # Requirements
  sudo apt-get install build-essential
  sudo apt-get install python-dev python3-dev
  sudo add-apt-repository ppa:ubuntu-toolchain-r/test
  sudo apt-get update
  sudo apt-get install gcc-4.8 g++-4.8
  sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8 60 --slave /usr/bin/g++ g++ /usr/bin/g++-4.8

  # Install node
  install_node

  # Install go
  #sudo apt-get install golang-go

  # Compile YCM
  cd ~/.vim/bundle/YouCompleteMe
  ./install.py --tern-completer 
}

# FUNCTION FOR COMPARING VERSIONS
# ###################################################################
function should_upgrade() {
    if [[ $1 == $2 ]]
    then
        return 1
    fi
    local IFS=.
    local i ver1=($1) ver2=($2)
    # fill empty fields in ver1 with zeros
    for ((i=${#ver1[@]}; i<${#ver2[@]}; i++))
    do
        ver1[i]=0
    done
    for ((i=0; i<${#ver1[@]}; i++))
    do
        if [[ -z ${ver2[i]} ]]
        then
            # fill empty fields in ver2 with zeros
            ver2[i]=0
        fi
        if ((10#${ver1[i]} > 10#${ver2[i]}))
        then
            return 1
        fi
        if ((10#${ver1[i]} < 10#${ver2[i]}))
        then
            return 0
        fi
    done
    return 1
}

# MAIN FUNCTIONS
# ###################################################################
if [ "$1" == "--help" ]; then
  echo "vim - compile vim and install all bundles"
  echo "cmake - install new version of cmake"
  echo "ycm - install youcompleteme"
  echo "tools - install basic tools"
  echo "all - INSTALL ALL THE ABOVE"
elif [ "$1" == "vim" ]; then
  compile_vim
  #install_vim
elif [ "$1" == "cmake" ]; then
  compile_cmake
elif [ "$1" == "ycm" ]; then
  compile_ycm
elif ["$1" == "tools" ]; then
  install_tools
elif [ "$1" == "all" ]; then
  install_tools
  compile_cmake
  compile_vim
  compile_ycm
else
  main
fi
} # this ensures the entire script is downloaded #
